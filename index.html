<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–ù–æ–æ–∫–∞—Ç –ù–æ–≤–æ—Å—Ç–∏ - –ñ–∞“£—ã–ª—ã–∫—Ç–∞—Ä | Nookat News</title>
  <meta name="description" content="–ù–æ–æ–∫–∞—Ç –ù–æ–≤–æ—Å—Ç–∏ - –≥–ª–∞–≤–Ω—ã–π –ø–æ—Ä—Ç–∞–ª –ù–æ–æ–∫–∞—Ç—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞. –ù–æ–≤–æ—Å—Ç–∏, —Ä—ã–Ω–æ–∫, –≤–∞–∫–∞–Ω—Å–∏–∏.">
  <meta name="keywords" content="–Ω–æ–æ–∫–∞—Ç –Ω–æ–≤–æ—Å—Ç–∏, –Ω–æ–æ–∫–∞—Ç –∂–∞“£—ã–ª—ã–∫—Ç–∞—Ä—ã, nookat news, —Ä—ã–Ω–æ–∫ –Ω–æ–æ–∫–∞—Ç, –≤–∞–∫–∞–Ω—Å–∏–∏ –Ω–æ–æ–∫–∞—Ç">
  <meta property="og:title" content="–ù–æ–æ–∫–∞—Ç –ù–æ–≤–æ—Å—Ç–∏ - Nookat News">
  <meta property="og:description" content="–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏, —Ä—ã–Ω–æ–∫ –∏ –≤–∞–∫–∞–Ω—Å–∏–∏ –ù–æ–æ–∫–∞—Ç—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞">
  <meta property="og:url" content="https://nookat.c6t.ru">
  <meta property="og:image" content="https://nookat.c6t.ru/images/nookatday.jpg">
  <meta name="robots" content="index, follow">
  <meta name="theme-color" content="#2563eb">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="styles (1).css">
</head>
<body>

<header>
  <div class="header-inner">
    <div class="logo" onclick="goTab('news')">
      <img src="images/nookatday.jpg" alt="Nookat" class="logo-avatar" id="logoAva">
      <div class="logo-text">
        <h1 data-ru="–ù–æ–æ–∫–∞—Ç –ù–æ–≤–æ—Å—Ç–∏" data-kg="–ù–æ–æ–∫–∞—Ç –ñ–∞“£—ã–ª—ã–∫—Ç–∞—Ä—ã">–ù–æ–æ–∫–∞—Ç –ù–æ–≤–æ—Å—Ç–∏</h1>
        <span data-ru="–ì–ª–∞–≤–Ω—ã–π –ø–æ—Ä—Ç–∞–ª —Ä–∞–π–æ–Ω–∞" data-kg="–†–∞–π–æ–Ω–¥—É–Ω –±–∞—à–∫—ã –ø–æ—Ä—Ç–∞–ª—ã">–ì–ª–∞–≤–Ω—ã–π –ø–æ—Ä—Ç–∞–ª —Ä–∞–π–æ–Ω–∞</span>
      </div>
    </div>
    <div class="header-right">
      <div class="lang-sw">
        <button data-lang="ru" class="on">RU</button>
        <button data-lang="kg">KG</button>
      </div>
      <button class="icon-btn" onclick="toggleTheme()" id="themeBtn" title="–¢–µ–º–∞">üåô</button>
      <div class="auth-btns" id="guestBtns">
        <button class="btn-login" onclick="openModal('loginModal')">–í–æ–π—Ç–∏</button>
        <button class="btn-reg" onclick="openModal('regModal')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>
      <img src="https://ui-avatars.com/api/?name=U&background=2563eb&color=fff"
           class="user-avatar-btn" id="userAvaBtn" onclick="handleAvaClick()" title="–ü—Ä–æ—Ñ–∏–ª—å">
    </div>
  </div>
  <nav>
    <div class="nav-inner">
      <button class="nav-tab on" data-tab="news" onclick="goTab('news')"><i class="fas fa-newspaper"></i> <span data-ru="–ù–æ–≤–æ—Å—Ç–∏" data-kg="–ñ–∞“£—ã–ª—ã–∫—Ç–∞—Ä">–ù–æ–≤–æ—Å—Ç–∏</span></button>
      <button class="nav-tab" data-tab="market" onclick="goTab('market')"><i class="fas fa-store"></i> <span data-ru="–†—ã–Ω–æ–∫" data-kg="–ë–∞–∑–∞—Ä">–†—ã–Ω–æ–∫</span></button>
      <button class="nav-tab" data-tab="jobs" onclick="goTab('jobs')"><i class="fas fa-briefcase"></i> <span data-ru="–í–∞–∫–∞–Ω—Å–∏–∏" data-kg="–í–∞–∫–∞–Ω—Å–∏—è–ª–∞—Ä">–í–∞–∫–∞–Ω—Å–∏–∏</span></button>
      <button class="nav-tab" data-tab="chat" onclick="goTab('chat')"><i class="fas fa-comments"></i> <span data-ru="–ß–∞—Ç" data-kg="–ß–∞—Ç">–ß–∞—Ç</span></button>
      <button class="nav-tab" data-tab="about" onclick="goTab('about')"><i class="fas fa-city"></i> <span data-ru="–û –≥–æ—Ä–æ–¥–µ" data-kg="–®–∞–∞—Ä –∂”©–Ω“Ø–Ω–¥”©">–û –≥–æ—Ä–æ–¥–µ</span></button>
      <button class="nav-tab" data-tab="contacts" onclick="goTab('contacts')"><i class="fas fa-address-book"></i> <span data-ru="–ö–æ–Ω—Ç–∞–∫—Ç—ã" data-kg="–ë–∞–π–ª–∞–Ω—ã—à—Ç–∞—Ä">–ö–æ–Ω—Ç–∞–∫—Ç—ã</span></button>
    </div>
  </nav>
</header>

<div class="container">

  <!-- –ù–û–í–û–°–¢–ò -->
  <div class="section on" id="sec-news">
    <div class="search-bar">
      <input type="text" id="newsSearch" placeholder="üîç –ü–æ–∏—Å–∫ –Ω–æ–≤–æ—Å—Ç–µ–π..." oninput="filterPosts()">
    </div>
    <div class="loader" id="newsLoader"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>
    <div class="news-grid" id="newsGrid"></div>
    <div class="empty" id="newsEmpty" style="display:none"><i class="fas fa-newspaper"></i><p>–ù–æ–≤–æ—Å—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</p></div>
  </div>

  <!-- –†–´–ù–û–ö -->
  <div class="section" id="sec-market">
    <div class="market-cats">
      <button class="cat-btn on" data-cat="all"><i class="fas fa-th"></i> <span data-ru="–í—Å–µ" data-kg="–ë–∞–∞—Ä—ã">–í—Å–µ</span></button>
      <button class="cat-btn" data-cat="tech"><i class="fas fa-laptop"></i> <span data-ru="–¢–µ—Ö–Ω–∏–∫–∞" data-kg="–¢–µ—Ö–Ω–∏–∫–∞">–¢–µ—Ö–Ω–∏–∫–∞</span></button>
      <button class="cat-btn" data-cat="land"><i class="fas fa-map-marked-alt"></i> <span data-ru="–£—á–∞—Å—Ç–∫–∏" data-kg="–£—á–∞—Å—Ç–æ–∫—Ç–æ—Ä">–£—á–∞—Å—Ç–∫–∏</span></button>
      <button class="cat-btn" data-cat="acc"><i class="fas fa-gem"></i> <span data-ru="–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã" data-kg="–ê–∫—Å–µ—Å—Å—É–∞—Ä–ª–∞—Ä">–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</span></button>
      <button class="cat-btn" data-cat="cars"><i class="fas fa-car"></i> <span data-ru="–ú–∞—à–∏–Ω—ã" data-kg="–£–Ω–∞–∞–ª–∞—Ä">–ú–∞—à–∏–Ω—ã</span></button>
      <button class="cat-btn" data-cat="animals"><i class="fas fa-paw"></i> <span data-ru="–ñ–∏–≤–æ—Ç–Ω—ã–µ" data-kg="–ñ–∞–Ω—ã–±–∞—Ä–ª–∞—Ä">–ñ–∏–≤–æ—Ç–Ω—ã–µ</span></button>
      <button class="cat-btn" data-cat="materials"><i class="fas fa-hammer"></i> <span data-ru="–ú–∞—Ç–µ—Ä–∏–∞–ª—ã" data-kg="–ú–∞—Ç–µ—Ä–∏–∞–ª–¥–∞—Ä">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</span></button>
    </div>
    <div class="search-bar">
      <input type="text" id="marketSearch" placeholder="üîç –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..." oninput="filterMarket()">
    </div>
    <div class="loader" id="marketLoader"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>
    <div class="market-grid" id="marketGrid"></div>
    <div class="empty" id="marketEmpty" style="display:none"><i class="fas fa-store"></i><p data-ru="–û–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç" data-kg="–ñ–∞—Ä—ã—è–ª–æ–æ–ª–æ—Ä –∂–æ–∫">–û–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p></div>
  </div>

  <!-- –í–ê–ö–ê–ù–°–ò–ò -->
  <div class="section" id="sec-jobs">
    <div class="search-bar">
      <input type="text" id="jobsSearch" placeholder="üîç –ü–æ–∏—Å–∫ –≤–∞–∫–∞–Ω—Å–∏–π..." oninput="filterJobs()">
    </div>
    <div class="loader" id="jobsLoader"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>
    <div class="jobs-list" id="jobsList"></div>
    <div class="empty" id="jobsEmpty" style="display:none"><i class="fas fa-briefcase"></i><p data-ru="–í–∞–∫–∞–Ω—Å–∏–π –ø–æ–∫–∞ –Ω–µ—Ç" data-kg="–í–∞–∫–∞–Ω—Å–∏—è–ª–∞—Ä –∂–æ–∫">–í–∞–∫–∞–Ω—Å–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p></div>
  </div>

  <!-- –ß–ê–¢ -->
  <div class="section" id="sec-chat">
    <div id="chatAuth" style="display:none" class="empty">
      <i class="fas fa-lock"></i>
      <p data-ru="–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —á–∞—Ç—É –Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏" data-kg="–ß–∞—Ç–∫–∞ –∫–∏—Ä“Ø“Ø “Ø—á“Ø–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∫–µ—Ä–µ–∫">–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —á–∞—Ç—É –Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏</p>
      <button class="btn-full" style="max-width:200px;margin:12px auto 0" onclick="openModal('loginModal')">–í–æ–π—Ç–∏</button>
    </div>
    <div id="chatSection" style="display:none">
      <button class="chat-back-btn" id="chatBackBtn" onclick="showChatList()">
        <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —á–∞—Ç–∞–º
      </button>
      <div class="chat-layout" id="chatLayout">
        <div class="chat-list" id="chatListPanel">
          <div class="chat-list-header">üí¨ –°–æ–æ–±—â–µ–Ω–∏—è</div>
          <div id="chatListItems"></div>
        </div>
        <div class="chat-window" id="chatWindowPanel">
          <div class="chat-empty" id="chatEmpty"><i class="fas fa-comments"></i><p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</p></div>
          <div id="chatActive" style="display:none;height:100%;flex-direction:column">
            <div class="chat-win-header">
              <div class="chat-win-header-ava" id="chatWinAva"></div>
              <div class="chat-win-header-name" id="chatWinName"></div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-area">
              <button class="chat-attach" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ">
                <i class="fas fa-paperclip"></i>
                <input type="file" accept="image/*" onchange="sendImg(event)">
              </button>
              <input class="chat-input" id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="if(event.key==='Enter')sendMsg()">
              <button class="chat-send" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- –û –ì–û–†–û–î–ï -->
  <div class="section" id="sec-about">
    <div class="about-card">
      <h2><i class="fas fa-city"></i> <span data-ru="–û –≥–æ—Ä–æ–¥–µ –ù–æ–æ–∫–∞—Ç" data-kg="–ù–æ–æ–∫–∞—Ç —à–∞–∞—Ä—ã –∂”©–Ω“Ø–Ω–¥”©">–û –≥–æ—Ä–æ–¥–µ –ù–æ–æ–∫–∞—Ç</span></h2>
      <p data-ru="–ù–æ–æ–∫–∞—Ç ‚Äî –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π —Ü–µ–Ω—Ç—Ä –ù–æ–æ–∫–∞—Ç—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞ –û—à—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–∞. –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω –≤ —é–≥–æ-–∑–∞–ø–∞–¥–Ω–æ–π —á–∞—Å—Ç–∏ —Å—Ç—Ä–∞–Ω—ã." data-kg="–ù–æ–æ–∫–∞—Ç ‚Äî –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–¥—ã–Ω –û—à –æ–±–ª–∞—Å—Ç—ã–Ω—ã–Ω –ù–æ–æ–∫–∞—Ç —Ä–∞–π–æ–Ω—É–Ω—É–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–¥–∏–∫ –±–æ—Ä–±–æ—Ä—É.">–ù–æ–æ–∫–∞—Ç ‚Äî –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π —Ü–µ–Ω—Ç—Ä –ù–æ–æ–∫–∞—Ç—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞ –û—à—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–∞. –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω –≤ —é–≥–æ-–∑–∞–ø–∞–¥–Ω–æ–π —á–∞—Å—Ç–∏ —Å—Ç—Ä–∞–Ω—ã.</p>
      <p data-ru="–ì–æ—Ä–æ–¥ –∏–∑–≤–µ—Å—Ç–µ–Ω —Å–≤–æ–µ–π –±–æ–≥–∞—Ç–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π, –∫—É–ª—å—Ç—É—Ä–Ω—ã–º –Ω–∞—Å–ª–µ–¥–∏–µ–º –∏ –≥–æ—Å—Ç–µ–ø—Ä–∏–∏–º–Ω—ã–º–∏ –∂–∏—Ç–µ–ª—è–º–∏. –ù–æ–æ–∫–∞—Ç –∏–≥—Ä–∞–µ—Ç –≤–∞–∂–Ω—É—é —Ä–æ–ª—å –≤ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–π –∂–∏–∑–Ω–∏ —Ä–µ–≥–∏–æ–Ω–∞." data-kg="–®–∞–∞—Ä ”©–∑“Ø–Ω“Ø–Ω –±–∞–π —Ç–∞—Ä—ã—Ö—ã –∂–∞–Ω–∞ –º–µ–π–º–∞–Ω–¥–æ—Å –∂–∞—à–æ–æ—á—É–ª–∞—Ä—ã –º–µ–Ω–µ–Ω –±–µ–ª–≥–∏–ª“Ø“Ø.">–ì–æ—Ä–æ–¥ –∏–∑–≤–µ—Å—Ç–µ–Ω —Å–≤–æ–µ–π –±–æ–≥–∞—Ç–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π, –∫—É–ª—å—Ç—É—Ä–Ω—ã–º –Ω–∞—Å–ª–µ–¥–∏–µ–º –∏ –≥–æ—Å—Ç–µ–ø—Ä–∏–∏–º–Ω—ã–º–∏ –∂–∏—Ç–µ–ª—è–º–∏.</p>
    </div>
  </div>

  <!-- –ö–û–ù–¢–ê–ö–¢–´ -->
  <div class="section" id="sec-contacts">
    <div class="about-card">
      <h2><i class="fas fa-phone"></i> <span data-ru="–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏" data-kg="–ë–∏–∑ –º–µ–Ω–µ–Ω –±–∞–π–ª–∞–Ω—ã—à—ã“£—ã–∑">–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏</span></h2>
      <p data-ru="–ï—Å—Ç—å –Ω–æ–≤–æ—Å—Ç—å –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ? –ü–∏—à–∏—Ç–µ –Ω–∞–º!" data-kg="–ñ–∞“£—ã–ª—ã–∫ –∂–µ —Å—É–Ω—É—à –±–∞—Ä–±—ã?">–ï—Å—Ç—å –Ω–æ–≤–æ—Å—Ç—å –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ? –ü–∏—à–∏—Ç–µ –Ω–∞–º!</p>
    </div>
    <div class="contact-grid">
      <div class="contact-item"><div class="contact-item-icon"><i class="fab fa-telegram" style="color:#0088cc"></i></div><h4>Telegram</h4><a href="https://t.me/Nookat_day" target="_blank">@Nookat_day</a><p data-ru="–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª" data-kg="–†–∞—Å–º–∏–π –∫–∞–Ω–∞–ª">–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª</p></div>
      <div class="contact-item"><div class="contact-item-icon"><i class="fab fa-instagram" style="color:#e1306c"></i></div><h4>Instagram</h4><a href="https://instagram.com/nookat.news" target="_blank">@nookat.news</a><p data-ru="–°–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–∞–º–∏" data-kg="–ë–∏–∑–¥–∏–Ω Instagram">–°–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–∞–º–∏</p></div>
      <div class="contact-item"><div class="contact-item-icon"><i class="fab fa-whatsapp" style="color:#25d366"></i></div><h4>WhatsApp</h4><a href="https://wa.me/+996701775688" target="_blank">+996 701 775 688</a><p data-ru="–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º" data-kg="–ë–∏–∑–≥–µ –∂–∞–∑—ã“£—ã–∑">–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º</p></div>
      <div class="contact-item"><div class="contact-item-icon"><i class="fas fa-envelope" style="color:var(--primary)"></i></div><h4>Email</h4><a href="mailto:nookat.nws@gmail.com">nookat.nws@gmail.com</a><p data-ru="–î–µ–ª–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã" data-kg="–ò—à —Å—É—Ä–æ–æ–ª–æ—Ä—É">–î–µ–ª–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã</p></div>
      <div class="contact-item"><div class="contact-item-icon"><i class="fas fa-phone" style="color:var(--success)"></i></div><h4>–¢–µ–ª–µ—Ñ–æ–Ω</h4><a href="tel:+996701775688">+996 701 775 688</a><p data-ru="–ó–≤–æ–Ω–∏—Ç–µ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è" data-kg="–ö–∞–∞–ª–∞–≥–∞–Ω —É–±–∞–∫—Ç–∞ —á–∞–ª—ã“£—ã–∑">–ó–≤–æ–Ω–∏—Ç–µ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è</p></div>
      <div class="contact-item"><div class="contact-item-icon"><i class="fas fa-map-marker-alt" style="color:var(--danger)"></i></div><h4>–ê–¥—Ä–µ—Å</h4><p style="color:var(--text);font-weight:700" data-ru="–≥. –ù–æ–æ–∫–∞—Ç, –û—à—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å" data-kg="–ù–æ–æ–∫–∞—Ç, –û—à –æ–±–ª–∞—Å—Ç—ã">–≥. –ù–æ–æ–∫–∞—Ç, –û—à—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</p></div>
    </div>
  </div>

  <!-- –ü–†–û–§–ò–õ–¨ -->
  <div class="section" id="sec-profile">
    <div class="profile-header">
      <img src="https://ui-avatars.com/api/?name=U&background=2563eb&color=fff" class="profile-ava" id="profileAva">
      <div class="profile-name" id="profileName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
      <div class="profile-email" id="profileEmail"></div>
    </div>
    <div class="profile-tabs">
      <button class="profile-tab on" onclick="switchProfileTab('myPosts',this)">üìã –ú–æ–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</button>
      <button class="profile-tab" onclick="switchProfileTab('settings',this)">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <button class="profile-tab" onclick="logout()" style="color:var(--danger)">üö™ –í—ã–π—Ç–∏</button>
    </div>
    <div id="profileMyPosts">
      <div class="loader" id="myPostsLoader" style="display:none"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>
      <div class="my-posts-grid" id="myPostsGrid"></div>
      <div class="empty" id="myPostsEmpty" style="display:none"><i class="fas fa-folder-open"></i><p>–í—ã –µ—â—ë –Ω–∏—á–µ–≥–æ –Ω–µ –ø—É–±–ª–∏–∫–æ–≤–∞–ª–∏</p></div>
    </div>
    <div id="profileSettings" style="display:none">
      <div class="about-card">
        <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h2>
        <div class="avatar-upload">
          <img src="https://ui-avatars.com/api/?name=U&background=2563eb&color=fff" class="avatar-preview-circle" id="settingsAvaPreview">
          <button class="avatar-upload-btn">üì∑ –°–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ<input type="file" accept="image/*" onchange="changeProfilePhoto(event)"></button>
        </div>
        <div class="form-group"><label>–ò–º—è</label><input class="form-input" id="settingsName" placeholder="–í–∞—à–µ –∏–º—è"></div>
        <div class="form-group"><label>–§–∞–º–∏–ª–∏—è</label><input class="form-input" id="settingsSurname" placeholder="–í–∞—à–∞ —Ñ–∞–º–∏–ª–∏—è"></div>
        <div class="form-group"><label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label><input class="form-input" type="password" id="settingsPass" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º ‚Äî –ø–∞—Ä–æ–ª—å –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è"></div>
        <button class="btn-full" onclick="saveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
      </div>
    </div>
  </div>

</div>

<!-- FAB -->
<button class="fab" id="fabBtn" onclick="handleFab()" title="–î–æ–±–∞–≤–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é"><i class="fas fa-plus"></i></button>
<button class="scroll-up" id="scrollUp" onclick="window.scrollTo({top:0,behavior:'smooth'})"><i class="fas fa-arrow-up"></i></button>

<!-- –í–•–û–î -->
<div class="overlay" id="loginModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <h2>üëã –í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</h2>
      <button class="close-btn" onclick="closeModal('loginModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="social-auth">
        <button class="social-btn" onclick="googleLogin()"><i class="fab fa-google" style="color:#ea4335"></i> Google</button>
        <button class="social-btn" onclick="openModal('phoneModal');closeModal('loginModal')"><i class="fas fa-phone" style="color:var(--success)"></i> –ü–æ –Ω–æ–º–µ—Ä—É</button>
      </div>
      <div class="divider">–∏–ª–∏ —á–µ—Ä–µ–∑ email</div>
      <div class="form-group"><label>Email</label><input class="form-input" id="loginEmail" type="email" placeholder="your@email.com" autocomplete="email"></div>
      <div class="form-group"><label>–ü–∞—Ä–æ–ª—å</label><input class="form-input" id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
      <div class="error-box" id="loginErr"><i class="fas fa-exclamation-circle"></i><span></span></div>
      <button class="btn-full" style="margin-top:14px" onclick="emailLogin()">–í–æ–π—Ç–∏</button>
      <div class="switch-link">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a onclick="openModal('regModal');closeModal('loginModal')">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></div>
    </div>
  </div>
</div>

<!-- –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø -->
<div class="overlay" id="regModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <h2>üöÄ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
      <button class="close-btn" onclick="closeModal('regModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="social-auth">
        <button class="social-btn" onclick="googleLogin()"><i class="fab fa-google" style="color:#ea4335"></i> Google</button>
        <button class="social-btn" onclick="openModal('phoneModal');closeModal('regModal')"><i class="fas fa-phone" style="color:var(--success)"></i> –ü–æ –Ω–æ–º–µ—Ä—É</button>
      </div>
      <div class="divider">–∏–ª–∏ —á–µ—Ä–µ–∑ email</div>
      <div class="avatar-upload">
        <img src="https://ui-avatars.com/api/?name=?&background=e2e8f0&color=64748b" class="avatar-preview-circle" id="regAvaPreview">
        <button class="avatar-upload-btn">üì∑ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ<input type="file" accept="image/*" onchange="previewRegAva(event)"></button>
        <span style="font-size:.78rem;color:var(--text2)">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
      </div>
      <div class="form-row">
        <div class="form-group"><label>–ò–º—è *</label><input class="form-input" id="regName" placeholder="–í–∞—à–µ –∏–º—è" autocomplete="given-name"></div>
        <div class="form-group"><label>–§–∞–º–∏–ª–∏—è</label><input class="form-input" id="regSurname" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ" autocomplete="family-name"></div>
      </div>
      <div class="form-group"><label>Email *</label><input class="form-input" id="regEmail" type="email" placeholder="your@email.com" autocomplete="email"></div>
      <div class="form-group">
        <label>–ü–∞—Ä–æ–ª—å *</label>
        <input class="form-input" id="regPass" type="password" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" autocomplete="new-password" oninput="checkStrength(this.value)">
        <div class="strength-bar"><div class="strength-fill" id="strengthFill"></div></div>
        <div style="font-size:.73rem;color:var(--text2);margin-top:3px" id="strengthText"></div>
      </div>
      <div class="form-group"><label>–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å *</label><input class="form-input" id="regPass2" type="password" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" autocomplete="new-password"></div>
      <div class="error-box" id="regErr"><i class="fas fa-exclamation-circle"></i><span></span></div>
      <button class="btn-full" style="margin-top:14px" onclick="emailRegister()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
      <div class="switch-link">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a onclick="openModal('loginModal');closeModal('regModal')">–í–æ–π—Ç–∏</a></div>
    </div>
  </div>
</div>

<!-- –¢–ï–õ–ï–§–û–ù -->
<div class="overlay" id="phoneModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <h2>üì± –í—Ö–æ–¥ –ø–æ –Ω–æ–º–µ—Ä—É</h2>
      <button class="close-btn" onclick="closeModal('phoneModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
        <div class="phone-row">
          <select class="form-select country-code" id="countryCode">
            <option value="+996">üá∞üá¨ +996</option>
            <option value="+7">üá∑üá∫ +7</option>
            <option value="+998">üá∫üáø +998</option>
            <option value="+992">üáπüáØ +992</option>
            <option value="+380">üá∫üá¶ +380</option>
          </select>
          <input class="form-input" id="phoneNum" type="tel" placeholder="700 000 000" autocomplete="tel">
        </div>
      </div>
      <div id="phoneCodeSection" style="display:none">
        <div class="form-group"><label>–ö–æ–¥ –∏–∑ SMS</label><input class="form-input" id="smsCode" placeholder="000000" inputmode="numeric" maxlength="6"></div>
        <button class="btn-full" onclick="verifyCode()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥</button>
      </div>
      <button class="btn-full" id="sendCodeBtn" onclick="sendSmsCode()">–ü–æ–ª—É—á–∏—Ç—å SMS-–∫–æ–¥</button>
      <div id="recaptcha-container"></div>
      <div class="error-box" id="phoneErr" style="margin-top:10px"><i class="fas fa-exclamation-circle"></i><span></span></div>
    </div>
  </div>
</div>

<!-- –î–û–ë–ê–í–ò–¢–¨ –ù–û–í–û–°–¢–¨ -->
<div class="overlay" id="addNewsModal">
  <div class="modal modal-lg">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <h2>üì∞ –ù–æ–≤–∞—è –Ω–æ–≤–æ—Å—Ç—å</h2>
      <button class="close-btn" onclick="closeModal('addNewsModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ *</label><input class="form-input" id="newTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–æ–≤–æ—Å—Ç–∏"></div>
      <div class="form-group"><label>–¢–µ–∫—Å—Ç *</label><textarea class="form-textarea" id="newText" rows="5" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ..."></textarea></div>
      <div class="form-group">
        <label>–§–æ—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <div class="file-drop"><input type="file" accept="image/*" id="newImg" onchange="previewFile(event,'newImgPreview')"><div class="file-drop-icon"><i class="fas fa-cloud-upload-alt"></i></div><p>–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ</p></div>
        <img class="img-preview" id="newImgPreview" alt="">
      </div>
      <div class="upload-progress" id="newsUploadProgress">
        <div class="upload-progress-text">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ...</div>
        <div class="upload-progress-bar"><div class="upload-progress-fill" id="newsUploadFill"></div></div>
      </div>
      <button class="btn-full" id="publishNewsBtn" onclick="publishNews()">‚ú® –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–æ–≤–æ—Å—Ç—å</button>
    </div>
  </div>
</div>

<!-- –î–û–ë–ê–í–ò–¢–¨ –û–ë–™–Ø–í–õ–ï–ù–ò–ï -->
<div class="overlay" id="addMarketModal">
  <div class="modal modal-lg">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <h2>üõçÔ∏è –ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h2>
      <button class="close-btn" onclick="closeModal('addMarketModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>–§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ *</label>
        <div class="file-drop"><input type="file" accept="image/*" id="mktImg" onchange="previewFile(event,'mktImgPreview')"><div class="file-drop-icon"><i class="fas fa-camera"></i></div><p>–î–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞</p></div>
        <img class="img-preview" id="mktImgPreview" alt="">
      </div>
      <div class="form-row">
        <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label><input class="form-input" id="mktTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"></div>
        <div class="form-group"><label>–¶–µ–Ω–∞ *</label><input class="form-input" id="mktPrice" type="number" placeholder="0 —Å–æ–º" inputmode="numeric"></div>
      </div>
      <div class="form-group"><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
        <select class="form-select" id="mktCat">
          <option value="tech">–¢–µ—Ö–Ω–∏–∫–∞</option><option value="land">–£—á–∞—Å—Ç–∫–∏</option>
          <option value="acc">–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</option><option value="cars">–ú–∞—à–∏–Ω—ã</option>
          <option value="animals">–ñ–∏–≤–æ—Ç–Ω—ã–µ</option><option value="materials">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</option>
        </select>
      </div>
      <div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea class="form-textarea" id="mktDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..."></textarea></div>
      <div class="form-group"><label>üìç –ú–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ</label><input class="form-input" id="mktLoc" placeholder="–ù–æ–æ–∫–∞—Ç, ..."></div>
      <div style="background:var(--bg);border-radius:12px;padding:13px;margin-bottom:13px">
        <p style="font-weight:800;margin-bottom:9px;font-size:.88rem">üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Å–≤—è–∑–∏</p>
        <div class="form-group" style="margin-bottom:7px">
          <div class="phone-row">
            <select class="form-select country-code" id="mktWaCode"><option value="+996">üá∞üá¨ +996</option><option value="+7">üá∑üá∫ +7</option></select>
            <input class="form-input" id="mktWa" placeholder="WhatsApp *" inputmode="tel">
          </div>
        </div>
        <div class="form-group" style="margin-bottom:7px">
          <div class="phone-row">
            <select class="form-select country-code" id="mktPhCode"><option value="+996">üá∞üá¨ +996</option><option value="+7">üá∑üá∫ +7</option></select>
            <input class="form-input" id="mktPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" inputmode="tel">
          </div>
        </div>
        <input class="form-input" id="mktTg" placeholder="Telegram: @username (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
      </div>
      <div class="upload-progress" id="mktUploadProgress">
        <div class="upload-progress-text">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ...</div>
        <div class="upload-progress-bar"><div class="upload-progress-fill" id="mktUploadFill"></div></div>
      </div>
      <button class="btn-full" id="publishMarketBtn" onclick="publishMarket()">üì§ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</button>
    </div>
  </div>
</div>

<!-- –î–û–ë–ê–í–ò–¢–¨ –í–ê–ö–ê–ù–°–ò–Æ -->
<div class="overlay" id="addJobModal">
  <div class="modal modal-lg">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <h2>üíº –ù–æ–≤–∞—è –≤–∞–∫–∞–Ω—Å–∏—è</h2>
      <button class="close-btn" onclick="closeModal('addJobModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label>–î–æ–ª–∂–Ω–æ—Å—Ç—å *</label><input class="form-input" id="jobTitle" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–æ–¥–∞–≤–µ—Ü"></div>
        <div class="form-group"><label>–ó–∞—Ä–ø–ª–∞—Ç–∞</label><input class="form-input" id="jobSalary" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 15 000 —Å–æ–º"></div>
      </div>
      <div class="form-group"><label>–†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å / –ö–æ–º–ø–∞–Ω–∏—è *</label><input class="form-input" id="jobCompany" placeholder="–í–∞—à–µ –∏–º—è –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏"></div>
      <div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏ *</label><textarea class="form-textarea" id="jobDesc" placeholder="–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è, —É—Å–ª–æ–≤–∏—è —Ä–∞–±–æ—Ç—ã..."></textarea></div>
      <div class="form-group"><label>üìç –ú–µ—Å—Ç–æ —Ä–∞–±–æ—Ç—ã</label><input class="form-input" id="jobLoc" placeholder="–ù–æ–æ–∫–∞—Ç, ..."></div>
      <div style="background:var(--bg);border-radius:12px;padding:13px;margin-bottom:13px">
        <p style="font-weight:800;margin-bottom:9px;font-size:.88rem">üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Å–≤—è–∑–∏</p>
        <div class="phone-row" style="margin-bottom:8px">
          <select class="form-select country-code" id="jobPhCode"><option value="+996">üá∞üá¨ +996</option><option value="+7">üá∑üá∫ +7</option></select>
          <input class="form-input" id="jobPhone" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ *" inputmode="tel">
        </div>
        <input class="form-input" id="jobTg" placeholder="Telegram: @username (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
      </div>
      <button class="btn-full" id="publishJobBtn" onclick="publishJob()">üì§ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤–∞–∫–∞–Ω—Å–∏—é</button>
    </div>
  </div>
</div>

<!-- –ü–†–û–°–ú–û–¢–† –ü–û–°–¢–ê -->
<div class="overlay" id="postModal">
  <div class="modal modal-lg">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <h2 id="postModalTitle" style="font-size:1.1rem;line-height:1.3"></h2>
      <button class="close-btn" onclick="closeModal('postModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <img id="postModalImg" style="width:100%;border-radius:12px;margin-bottom:13px;display:none" alt="">
      <div style="font-size:.77rem;color:var(--text2);margin-bottom:11px" id="postModalDate"></div>
      <div id="postModalBody" style="line-height:1.8;font-size:.93rem;margin-bottom:15px;white-space:pre-wrap"></div>
      <div id="postModalContacts"></div>
      <button class="open-chat-btn" id="postChatBtn" style="display:none" onclick="startChatFromPost()">
        <i class="fas fa-comments"></i> –ù–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ–¥–∞–≤—Ü—É
      </button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
// –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏
window.onerror = () => true;
window.onunhandledrejection = () => true;

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
  signInWithPopup, GoogleAuthProvider, RecaptchaVerifier, signInWithPhoneNumber,
  onAuthStateChanged, signOut, updateProfile, updatePassword
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc, query, orderBy, onSnapshot,
  deleteDoc, doc, updateDoc, increment, where, getDocs,
  serverTimestamp, setDoc, getDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const _c = {
  k:"AIzaSyAHNE24jDk8wysKkctBBFNSrSgmQr3PPaM",
  d:"mydistrictnews-fa379.firebaseapp.com",
  p:"mydistrictnews-fa379",
  s:"mydistrictnews-fa379.firebasestorage.app",
  m:"62802053109",
  a:"1:62802053109:web:f4024816d979a79890c2bc"
};
const app = initializeApp({apiKey:_c.k,authDomain:_c.d,projectId:_c.p,storageBucket:_c.s,messagingSenderId:_c.m,appId:_c.a});
const auth = getAuth(app);
const db = getFirestore(app);

// UID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ‚Äî –∑–∞–º–µ–Ω–∏—Ç–µ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞
const _A = "nF0RuTEUtSWF7jkxsJ3QoTsqOKm2";

// Cloudinary
const _CN = 'dsd7kqaon';
const _UP = 'herrozzv';

async function uploadPhoto(file, onProgress) {
  return new Promise((res, rej) => {
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', _UP);
    const x = new XMLHttpRequest();
    x.open('POST', `https://api.cloudinary.com/v1_1/${_CN}/image/upload`);
    if (onProgress) x.upload.onprogress = e => { if(e.lengthComputable) onProgress(Math.round(e.loaded/e.total*100)); };
    x.onload = () => {
      try {
        const d = JSON.parse(x.responseText);
        if (d.secure_url) res(d.secure_url);
        else rej(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ'));
      } catch(e) { rej(new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ')); }
    };
    x.onerror = () => rej(new Error('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç'));
    x.send(fd);
  });
}

// –°–æ—Å—Ç–æ—è–Ω–∏–µ
let _u = null, allNews = [], allMarket = [], allJobs = [];
let _cat = 'all', _chatId = null, _chatUnsub = null;
let _postData = null, _avaFile = null, _avaClicks = 0, _avaTimer = null;
const _store = new Map();

// === –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ===
onAuthStateChanged(auth, async user => {
  _u = user;
  const gBtns = document.getElementById('guestBtns');
  const avaBtn = document.getElementById('userAvaBtn');
  if (user) {
    gBtns.style.display = 'none';
    avaBtn.style.display = 'block';
    avaBtn.src = user.photoURL || _ava(user.displayName);
    _updateProfileUI();
    if (document.getElementById('sec-chat').classList.contains('on')) _showChat();
  } else {
    gBtns.style.display = 'flex';
    avaBtn.style.display = 'none';
  }
});

function _ava(name) {
  return `https://ui-avatars.com/api/?name=${encodeURIComponent(name||'U')}&background=2563eb&color=fff`;
}

function _updateProfileUI() {
  if (!_u) return;
  const name = _u.displayName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
  document.getElementById('profileName').textContent = name;
  document.getElementById('profileEmail').textContent = _u.email || _u.phoneNumber || '';
  const av = _u.photoURL || _ava(name);
  ['profileAva','settingsAvaPreview'].forEach(id => document.getElementById(id).src = av);
  document.getElementById('settingsName').value = name.split(' ')[0] || '';
  document.getElementById('settingsSurname').value = name.split(' ')[1] || '';
}

window.handleAvaClick = () => {
  _avaClicks++;
  clearTimeout(_avaTimer);
  _avaTimer = setTimeout(() => _avaClicks = 0, 800);
  if (_avaClicks >= 3) { _avaClicks = 0; }
  goTab('profile');
};

function _fbErr(code) {
  const m = {
    'auth/email-already-in-use':   '–≠—Ç–æ—Ç email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏.',
    'auth/invalid-email':           '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å.',
    'auth/wrong-password':          '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.',
    'auth/invalid-credential':      '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å.',
    'auth/user-not-found':          '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω.',
    'auth/weak-password':           '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –ø—Ä–æ—Å—Ç–æ–π. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤.',
    'auth/too-many-requests':       '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.',
    'auth/network-request-failed':  '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.',
    'auth/popup-closed-by-user':    '–û–∫–Ω–æ –≤—Ö–æ–¥–∞ –±—ã–ª–æ –∑–∞–∫—Ä—ã—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.',
    'auth/cancelled-popup-request': '–í—Ö–æ–¥ –æ—Ç–º–µ–Ω—ë–Ω.',
    'auth/configuration-not-found': '–í—Ö–æ–¥ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.',
    'auth/invalid-phone-number':    '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.',
    'auth/invalid-verification-code':'–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –∏–∑ SMS. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ –≤–≤–µ–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.',
    'auth/code-expired':            '–ö–æ–¥ –∏–∑ SMS —É—Å—Ç–∞—Ä–µ–ª. –ó–∞–ø—Ä–æ—Å–∏—Ç–µ –Ω–æ–≤—ã–π.',
    'auth/requires-recent-login':   '–î–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç –∑–∞–Ω–æ–≤–æ.',
  };
  return m[code] || '–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
}

function showErrBox(id, msg) {
  const el = document.getElementById(id);
  if (!el) return;
  el.querySelector('span').textContent = msg;
  el.classList.add('show');
}
function hideErrBox(id) {
  const el = document.getElementById(id);
  if (el) el.classList.remove('show');
}

window.emailRegister = async () => {
  hideErrBox('regErr');
  const name   = document.getElementById('regName').value.trim();
  const surname= document.getElementById('regSurname').value.trim();
  const email  = document.getElementById('regEmail').value.trim();
  const pass   = document.getElementById('regPass').value;
  const pass2  = document.getElementById('regPass2').value;

  if (!name)           { showErrBox('regErr','–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è.'); return; }
  if (!email)          { showErrBox('regErr','–í–≤–µ–¥–∏—Ç–µ email –∞–¥—Ä–µ—Å.'); return; }
  if (pass.length < 6) { showErrBox('regErr','–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤.'); return; }
  if (pass !== pass2)  { showErrBox('regErr','–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ –≤–≤–µ–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.'); return; }

  const btn = document.getElementById('regModal').querySelector('.btn-full:last-of-type');
  btn.disabled = true; btn.textContent = '‚è≥ –°–æ–∑–¥–∞—ë–º –∞–∫–∫–∞—É–Ω—Ç...';

  try {
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    let photoURL = null;
    if (_avaFile) {
      showToast('warn','‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ...');
      photoURL = await uploadPhoto(_avaFile);
    }
    await updateProfile(cred.user, { displayName: name+(surname?' '+surname:''), photoURL });
    const userRef = doc(db,'users',cred.user.uid);
    const userSnap = await getDoc(userRef);
    if (!userSnap.exists()) {
      await setDoc(userRef, {
        name, surname, email, photoURL: photoURL||null, createdAt: serverTimestamp()
      });
    }
    _avaFile = null;
    closeModal('regModal');
    showToast('ok','‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, '+name+'!');
  } catch(e) {
    showErrBox('regErr', _fbErr(e.code));
  }
  btn.disabled = false; btn.textContent = '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç';
};

window.emailLogin = async () => {
  hideErrBox('loginErr');
  const email = document.getElementById('loginEmail').value.trim();
  const pass  = document.getElementById('loginPass').value;
  if (!email) { showErrBox('loginErr','–í–≤–µ–¥–∏—Ç–µ email –∞–¥—Ä–µ—Å.'); return; }
  if (!pass)  { showErrBox('loginErr','–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å.'); return; }

  const btn = document.getElementById('loginModal').querySelector('.btn-full');
  btn.disabled = true; btn.textContent = '‚è≥ –í—Ö–æ–¥–∏–º...';

  try {
    await signInWithEmailAndPassword(auth, email, pass);
    closeModal('loginModal');
    showToast('ok','‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏!');
  } catch(e) {
    showErrBox('loginErr', _fbErr(e.code));
  }
  btn.disabled = false; btn.textContent = '–í–æ–π—Ç–∏';
};

window.googleLogin = async () => {
  try {
    const r = await signInWithPopup(auth, new GoogleAuthProvider());
    const ref = doc(db,'users',r.user.uid);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      await setDoc(ref, { name: r.user.displayName||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', email: r.user.email, photoURL: r.user.photoURL||null, createdAt: serverTimestamp() });
    }
    closeModal('loginModal'); closeModal('regModal');
    showToast('ok','‚úÖ –í—Ö–æ–¥ —á–µ—Ä–µ–∑ Google –≤—ã–ø–æ–ª–Ω–µ–Ω!');
  } catch(e) {
    if (e.code !== 'auth/popup-closed-by-user' && e.code !== 'auth/cancelled-popup-request') {
      showToast('err', _fbErr(e.code));
    }
  }
};

window.sendSmsCode = async () => {
  if (window.recaptchaVerifier) {
    window.recaptchaVerifier.clear();
    window.recaptchaVerifier = null;
  }
  hideErrBox('phoneErr');
  const code = document.getElementById('countryCode').value;
  const num  = document.getElementById('phoneNum').value.trim();
  if (!num) { showErrBox('phoneErr','–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.'); return; }
  const btn = document.getElementById('sendCodeBtn');
  btn.disabled = true; btn.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';
  try {
    window.recaptchaVerifier = new RecaptchaVerifier(auth,'recaptcha-container',{size:'invisible'});
    await window.recaptchaVerifier.render();
    window._confirm = await signInWithPhoneNumber(auth, code+num, window.recaptchaVerifier);
    document.getElementById('phoneCodeSection').style.display = 'block';
    btn.style.display = 'none';
    showToast('ok','üì± SMS –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
  } catch(e) {
    showErrBox('phoneErr', _fbErr(e.code));
    btn.disabled = false; btn.textContent = '–ü–æ–ª—É—á–∏—Ç—å SMS-–∫–æ–¥';
  }
};

window.verifyCode = async () => {
  hideErrBox('phoneErr');
  const code = document.getElementById('smsCode').value.trim();
  if (!code) { showErrBox('phoneErr','–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ SMS.'); return; }
  try {
    await window._confirm.confirm(code);
    closeModal('phoneModal');
    showToast('ok','‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!');
  } catch(e) {
    showErrBox('phoneErr', _fbErr(e.code));
  }
};

window.logout = async () => {
  await signOut(auth);
  goTab('news');
  showToast('ok','üëã –í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞');
};

window.changeProfilePhoto = async (e) => {
  const file = e.target.files[0];
  if (!file || !_u) return;
  showToast('warn','‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ...');
  try {
    const url = await uploadPhoto(file);
    await updateProfile(_u, {photoURL:url});
    await updateDoc(doc(db,'users',_u.uid), {photoURL:url});
    ['settingsAvaPreview','profileAva','userAvaBtn'].forEach(id => document.getElementById(id).src = url);
    showToast('ok','‚úÖ –§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ!');
  } catch(e) { showToast('err','–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.'); }
};

window.publishNews = async () => {
  if (!_u || _u.uid !== _A) { showToast('err','‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤'); return; }
  const title = document.getElementById('newTitle').value.trim();
  const text  = document.getElementById('newText').value.trim();
  const file  = document.getElementById('newImg').files[0];
  if (!title) { showToast('warn','‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–æ–≤–æ—Å—Ç–∏'); return; }
  if (!text)  { showToast('warn','‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏'); return; }

  const btn = document.getElementById('publishNewsBtn');
  btn.disabled = true; btn.textContent = '‚è≥ –ü—É–±–ª–∏–∫–∞—Ü–∏—è...';

  try {
    let img = '';
    if (file) {
      document.getElementById('newsUploadProgress').style.display = 'block';
      img = await uploadPhoto(file, p => { document.getElementById('newsUploadFill').style.width = p+'%'; });
      document.getElementById('newsUploadProgress').style.display = 'none';
    }
    await addDoc(collection(db,'posts'), { title, text, img, date:serverTimestamp(), views:0, likes:0, hearts:0, fire:0, authorId:_u.uid });
    closeModal('addNewsModal');
    ['newTitle','newText'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('newImg').value = '';
    document.getElementById('newImgPreview').style.display = 'none';
    showToast('ok','‚úÖ –ù–æ–≤–æ—Å—Ç—å —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!');
  } catch(e) { showToast('err','–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.'); }

  btn.disabled = false; btn.textContent = '‚ú® –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–æ–≤–æ—Å—Ç—å';
};

window.publishMarket = async () => {
  if (!_u) { openModal('loginModal'); return; }
  const title = document.getElementById('mktTitle').value.trim();
  const price = document.getElementById('mktPrice').value;
  const waNum = document.getElementById('mktWa').value.trim();
  const file  = document.getElementById('mktImg').files[0];

  if (!title)  { showToast('warn','‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞'); return; }
  if (!price)  { showToast('warn','‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É —Ç–æ–≤–∞—Ä–∞'); return; }
  if (!waNum)  { showToast('warn','‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ WhatsApp –¥–ª—è —Å–≤—è–∑–∏'); return; }
  if (!file)   { showToast('warn','‚ö†Ô∏è –î–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞'); return; }

  const btn = document.getElementById('publishMarketBtn');
  btn.disabled = true; btn.textContent = '‚è≥ –ü—É–±–ª–∏–∫–∞—Ü–∏—è...';

  try {
    document.getElementById('mktUploadProgress').style.display = 'block';
    const img = await uploadPhoto(file, p => { document.getElementById('mktUploadFill').style.width = p+'%'; });
    document.getElementById('mktUploadProgress').style.display = 'none';

    await addDoc(collection(db,'market'), {
      title, price:Number(price),
      cat:   document.getElementById('mktCat').value,
      desc:  document.getElementById('mktDesc').value.trim(),
      loc:   document.getElementById('mktLoc').value.trim(),
      img,
      wa:    document.getElementById('mktWaCode').value + waNum,
      phone: document.getElementById('mktPhCode').value + document.getElementById('mktPhone').value.trim(),
      tg:    document.getElementById('mktTg').value.trim(),
      date:serverTimestamp(), views:0, likes:0,
      authorId:_u.uid, authorName:_u.displayName||'–ê–Ω–æ–Ω–∏–º', authorPhoto:_u.photoURL||null
    });
    closeModal('addMarketModal');
    ['mktTitle','mktPrice','mktDesc','mktLoc','mktWa','mktPhone','mktTg'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('mktImg').value = '';
    document.getElementById('mktImgPreview').style.display = 'none';
    showToast('ok','‚úÖ –û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!');
  } catch(e) { showToast('err','–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.'); }

  btn.disabled = false; btn.textContent = 'üì§ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ';
};

window.publishJob = async () => {
  if (!_u) { openModal('loginModal'); return; }
  const title   = document.getElementById('jobTitle').value.trim();
  const company = document.getElementById('jobCompany').value.trim();
  const desc    = document.getElementById('jobDesc').value.trim();
  const phone   = document.getElementById('jobPhone').value.trim();

  if (!title)   { showToast('warn','‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏'); return; }
  if (!company) { showToast('warn','‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—è –∏–ª–∏ –∫–æ–º–ø–∞–Ω–∏—é'); return; }
  if (!desc)    { showToast('warn','‚ö†Ô∏è –ù–∞–ø–∏—à–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏'); return; }
  if (!phone)   { showToast('warn','‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è —Å–≤—è–∑–∏'); return; }

  const btn = document.getElementById('publishJobBtn');
  btn.disabled = true; btn.textContent = '‚è≥ –ü—É–±–ª–∏–∫–∞—Ü–∏—è...';

  try {
    await addDoc(collection(db,'jobs'), {
      title, company, desc,
      salary: document.getElementById('jobSalary').value.trim(),
      loc:    document.getElementById('jobLoc').value.trim(),
      phone:  document.getElementById('jobPhCode').value + phone,
      tg:     document.getElementById('jobTg').value.trim(),
      date:serverTimestamp(), views:0,
      authorId:_u.uid, authorName:_u.displayName||'–ê–Ω–æ–Ω–∏–º'
    });
    closeModal('addJobModal');
    ['jobTitle','jobSalary','jobCompany','jobDesc','jobLoc','jobPhone','jobTg'].forEach(id => document.getElementById(id).value = '');
    showToast('ok','‚úÖ –í–∞–∫–∞–Ω—Å–∏—è –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!');
  } catch(e) { showToast('err','–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.'); }

  btn.disabled = false; btn.textContent = 'üì§ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤–∞–∫–∞–Ω—Å–∏—é';
};

onSnapshot(query(collection(db,'posts'),   orderBy('date','desc')), snap => { allNews   = snap.docs.map(d=>({id:d.id,...d.data()})); filterPosts();  document.getElementById('newsLoader').style.display='none'; });
onSnapshot(query(collection(db,'market'),  orderBy('date','desc')), snap => { allMarket = snap.docs.map(d=>({id:d.id,...d.data()})); filterMarket(); document.getElementById('marketLoader').style.display='none'; });
onSnapshot(query(collection(db,'jobs'),    orderBy('date','desc')), snap => { allJobs   = snap.docs.map(d=>({id:d.id,...d.data()})); filterJobs();   document.getElementById('jobsLoader').style.display='none'; });

window.filterPosts  = () => { const q=document.getElementById('newsSearch').value.toLowerCase(); renderNews(allNews.filter(p=>p.title?.toLowerCase().includes(q)||p.text?.toLowerCase().includes(q))); };
window.filterMarket = () => { const q=document.getElementById('marketSearch').value.toLowerCase(); let f=allMarket.filter(p=>p.title?.toLowerCase().includes(q)||p.desc?.toLowerCase().includes(q)); if(_cat!=='all') f=f.filter(p=>p.cat===_cat); renderMarket(f); };
window.filterJobs   = () => { const q=document.getElementById('jobsSearch').value.toLowerCase(); renderJobs(allJobs.filter(p=>p.title?.toLowerCase().includes(q)||p.company?.toLowerCase().includes(q)||p.desc?.toLowerCase().includes(q))); };

function _esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function _fmtD(d){ const now=new Date(),diff=now-d; if(diff<60000)return'—Ç–æ–ª—å–∫–æ —á—Ç–æ'; if(diff<3600000)return Math.floor(diff/60000)+' –º–∏–Ω –Ω–∞–∑–∞–¥'; if(diff<86400000)return Math.floor(diff/3600000)+' —á –Ω–∞–∑–∞–¥'; if(diff<604800000)return Math.floor(diff/86400000)+' –¥ –Ω–∞–∑–∞–¥'; return d.toLocaleDateString('ru-RU',{day:'numeric',month:'short'}); }
function _fmtT(d){ return d.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}); }
function _fmtP(p){ return Number(p).toLocaleString('ru-RU')+' —Å–æ–º'; }

function renderNews(posts) {
  const grid=document.getElementById('newsGrid'), empty=document.getElementById('newsEmpty');
  if(!posts.length){grid.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  posts.forEach(p=>_store.set('n_'+p.id,p));
  grid.innerHTML=posts.map(p=>{
    const ds=p.date?.toDate?_fmtD(p.date.toDate()):'';
    const isNew=p.date?.toDate&&(Date.now()-p.date.toDate().getTime())<86400000;
    return `<div class="news-card">
      <button class="three-dots" onclick="toggleDD('nd_${p.id}',event)"><i class="fas fa-ellipsis-v"></i></button>
      <div class="dropdown" id="nd_${p.id}">
        <div class="dropdown-item" onclick="sharePost('${p.id}')"><i class="fas fa-share-alt"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</div>
        <div class="dropdown-item red" onclick="reportPost()"><i class="fas fa-flag"></i> –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</div>
        ${_u?.uid===_A?`<div class="dropdown-item red" onclick="delPost('posts','${p.id}')"><i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å</div>`:''}
      </div>
      ${p.img?`<img class="news-card-img" src="${p.img}" alt="" loading="lazy">`:''}
      <div class="news-card-body">
        <div class="news-card-meta">
          <span class="news-card-date">${ds}</span>
          ${isNew?'<span class="news-card-badge">–ù–æ–≤–æ–µ</span>':''}
        </div>
        <h3 onclick="openNews('${p.id}')">${_esc(p.title)}</h3>
        <p class="news-card-text">${_esc((p.text||'').substring(0,110))}${(p.text||'').length>110?'...':''}</p>
        <div class="news-card-footer">
          <div class="reactions">
            <button class="reaction-btn" onclick="react('posts','${p.id}','likes',this)">üëç ${p.likes||0}</button>
            <button class="reaction-btn" onclick="react('posts','${p.id}','hearts',this)">‚ù§Ô∏è ${p.hearts||0}</button>
            <button class="reaction-btn" onclick="react('posts','${p.id}','fire',this)">üî• ${p.fire||0}</button>
          </div>
          <div class="post-stats"><i class="fas fa-eye"></i> ${p.views||0}</div>
        </div>
      </div>
    </div>`;
  }).join('');
}

function renderMarket(items) {
  const grid=document.getElementById('marketGrid'), empty=document.getElementById('marketEmpty');
  if(!items.length){grid.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  items.forEach(p=>_store.set('m_'+p.id,p));
  grid.innerHTML=items.map(p=>`
    <div class="market-card" onclick="openMarket('${p.id}')">
      <button class="three-dots" onclick="toggleDD('md_${p.id}',event);event.stopPropagation()"><i class="fas fa-ellipsis-v"></i></button>
      <div class="dropdown" id="md_${p.id}">
        <div class="dropdown-item" onclick="sharePost('${p.id}');event.stopPropagation()"><i class="fas fa-share-alt"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</div>
        <div class="dropdown-item red" onclick="reportPost();event.stopPropagation()"><i class="fas fa-flag"></i> –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</div>
        ${(_u?.uid===p.authorId||_u?.uid===_A)?`<div class="dropdown-item red" onclick="delPost('market','${p.id}');event.stopPropagation()"><i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å</div>`:''}
      </div>
      <img class="market-card-img" src="${p.img}" alt="" loading="lazy">
      <div class="market-card-body">
        <div class="market-card-price">${_fmtP(p.price)}</div>
        <div class="market-card-title">${_esc(p.title)}</div>
        <div class="market-card-loc"><i class="fas fa-map-marker-alt"></i> ${_esc(p.loc||'–ù–æ–æ–∫–∞—Ç')}</div>
        <div class="market-card-foot">
          <div class="market-card-seller">
            <img class="seller-ava" src="${p.authorPhoto||_ava(p.authorName)}" alt="">
            ${_esc(p.authorName||'–ê–Ω–æ–Ω–∏–º')}
          </div>
          <div class="post-stats"><i class="fas fa-eye"></i> ${p.views||0}</div>
        </div>
      </div>
    </div>`).join('');
}

function renderJobs(jobs) {
  const list=document.getElementById('jobsList'), empty=document.getElementById('jobsEmpty');
  if(!jobs.length){list.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  jobs.forEach(p=>_store.set('j_'+p.id,p));
  list.innerHTML=jobs.map(p=>`
    <div class="job-card" onclick="openJob('${p.id}')">
      <button class="three-dots" onclick="toggleDD('jd_${p.id}',event);event.stopPropagation()"><i class="fas fa-ellipsis-v"></i></button>
      <div class="dropdown" id="jd_${p.id}">
        <div class="dropdown-item" onclick="sharePost('${p.id}');event.stopPropagation()"><i class="fas fa-share-alt"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</div>
        <div class="dropdown-item red" onclick="reportPost();event.stopPropagation()"><i class="fas fa-flag"></i> –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</div>
        ${(_u?.uid===p.authorId||_u?.uid===_A)?`<div class="dropdown-item red" onclick="delPost('jobs','${p.id}');event.stopPropagation()"><i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å</div>`:''}
      </div>
      <div class="job-header">
        <div class="job-title">${_esc(p.title)}</div>
        ${p.salary?`<div class="job-salary">${_esc(p.salary)}</div>`:''}
      </div>
      <div class="job-company"><i class="fas fa-building"></i> ${_esc(p.company)}</div>
      <div class="job-tags">${p.loc?`<span class="job-tag"><i class="fas fa-map-marker-alt"></i> ${_esc(p.loc)}</span>`:''}</div>
      <div class="job-foot">
        <span class="job-date">${p.date?.toDate?_fmtD(p.date.toDate()):''}</span>
        <div class="post-stats"><i class="fas fa-eye"></i> ${p.views||0}</div>
      </div>
    </div>`).join('');
}

async function countView(coll, id, authorId) {
  if (_u && _u.uid === authorId) return;
  const key = `viewed_${coll}_${id}`;
  if (localStorage.getItem(key)) return;
  try {
    await updateDoc(doc(db, coll, id), { views: increment(1) });
    localStorage.setItem(key, Date.now());
  } catch(e) {}
}

window.openNews = async (id) => {
  const p = _store.get('n_'+id); if(!p) return;
  _postData = p;
  document.getElementById('postModalTitle').textContent = p.title;
  document.getElementById('postModalBody').textContent = p.text;
  document.getElementById('postModalDate').textContent = 'üìÖ '+(p.date?.toDate?_fmtD(p.date.toDate()):'');
  const img = document.getElementById('postModalImg');
  p.img?(img.src=p.img,img.style.display='block'):img.style.display='none';
  document.getElementById('postModalContacts').innerHTML='';
  document.getElementById('postChatBtn').style.display='none';
  openModal('postModal');
  await countView('posts', id, p.authorId);
};

window.openMarket = async (id) => {
  const p = _store.get('m_'+id); if(!p) return;
  _postData = p;
  document.getElementById('postModalTitle').textContent = p.title;
  document.getElementById('postModalBody').innerHTML = `<div style="font-size:1.25rem;font-weight:900;color:var(--primary);margin-bottom:8px">${_fmtP(p.price)}</div><p>${_esc(p.desc||'')}</p>${p.loc?`<p style="margin-top:8px;color:var(--text2)"><i class="fas fa-map-marker-alt"></i> ${_esc(p.loc)}</p>`:''}`;
  document.getElementById('postModalDate').textContent = p.date?.toDate?_fmtD(p.date.toDate()):'';
  const img=document.getElementById('postModalImg');
  p.img?(img.src=p.img,img.style.display='block'):img.style.display='none';
  let c='';
  if(p.wa)    c+=`<div class="post-contact-row"><i class="fab fa-whatsapp" style="color:#25d366"></i><a href="https://wa.me/${p.wa.replace(/\D/g,'')}" target="_blank">${_esc(p.wa)}</a></div>`;
  if(p.phone) c+=`<div class="post-contact-row"><i class="fas fa-phone" style="color:var(--success)"></i><a href="tel:${p.phone}">${_esc(p.phone)}</a></div>`;
  if(p.tg)    c+=`<div class="post-contact-row"><i class="fab fa-telegram" style="color:#0088cc"></i><span>${_esc(p.tg)}</span></div>`;
  document.getElementById('postModalContacts').innerHTML=c;
  document.getElementById('postChatBtn').style.display=(p.authorId&&_u&&p.authorId!==_u.uid)?'flex':'none';
  openModal('postModal');
  await countView('market', id, p.authorId);
};

window.openJob = async (id) => {
  const p = _store.get('j_'+id); if(!p) return;
  _postData = p;
  document.getElementById('postModalTitle').textContent = p.title;
  document.getElementById('postModalBody').innerHTML = `<p style="font-weight:700;margin-bottom:7px"><i class="fas fa-building"></i> ${_esc(p.company)}</p>${p.salary?`<p style="color:var(--success);font-weight:900;font-size:1.1rem;margin-bottom:10px">${_esc(p.salary)}</p>`:''}<p>${_esc(p.desc)}</p>${p.loc?`<p style="margin-top:8px;color:var(--text2)"><i class="fas fa-map-marker-alt"></i> ${_esc(p.loc)}</p>`:''}`;
  document.getElementById('postModalDate').textContent = p.date?.toDate?_fmtD(p.date.toDate()):'';
  document.getElementById('postModalImg').style.display='none';
  let c='';
  if(p.phone) c+=`<div class="post-contact-row"><i class="fas fa-phone" style="color:var(--success)"></i><a href="tel:${p.phone}">${_esc(p.phone)}</a></div>`;
  if(p.tg)    c+=`<div class="post-contact-row"><i class="fab fa-telegram" style="color:#0088cc"></i><span>${_esc(p.tg)}</span></div>`;
  document.getElementById('postModalContacts').innerHTML=c;
  document.getElementById('postChatBtn').style.display=(p.authorId&&_u&&p.authorId!==_u.uid)?'flex':'none';
  openModal('postModal');
  await countView('jobs', id, p.authorId);
};

window.react = async (coll,id,field,btn) => {
  if(!_u){showToast('warn','‚ö†Ô∏è –í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–ª—è—Ç—å —Ä–µ–∞–∫—Ü–∏–∏');return;}
  btn.classList.toggle('active');
  try { await updateDoc(doc(db,coll,id),{[field]:increment(btn.classList.contains('active')?1:-1)}); } catch(e){}
};

window.delPost = async (coll, id) => {
  const p = _store.get(coll[0]+'_'+id) || _store.get(coll.substring(0,1)+'_'+id);
  const isAdmin  = _u?.uid === _A;
  const isAuthor = _u?.uid === p?.authorId;
  if (!isAdmin && !isAuthor) { showToast('err','‚ùå –ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è'); return; }
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø—É–±–ª–∏–∫–∞—Ü–∏—é?')) return;
  try {
    await deleteDoc(doc(db, coll, id));
    _store.delete(coll[0]+'_'+id);
    showToast('ok','‚úÖ –ü—É–±–ª–∏–∫–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞');
  } catch(e) { showToast('err','–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.'); }
};

async function loadMyPosts() {
  if(!_u) return;
  const loader=document.getElementById('myPostsLoader');
  const grid=document.getElementById('myPostsGrid');
  const empty=document.getElementById('myPostsEmpty');
  loader.style.display='block'; grid.innerHTML=''; empty.style.display='none';
  try {
    const [ms,js] = await Promise.all([
      getDocs(query(collection(db,'market'),where('authorId','==',_u.uid),orderBy('date','desc'))),
      getDocs(query(collection(db,'jobs'),  where('authorId','==',_u.uid),orderBy('date','desc')))
    ]);
    const items = [...ms.docs.map(d=>({id:d.id,type:'market',...d.data()})),...js.docs.map(d=>({id:d.id,type:'jobs',...d.data()}))];
    loader.style.display='none';
    if(!items.length){empty.style.display='block';return;}
    const tl={'market':'üõçÔ∏è –†—ã–Ω–æ–∫','jobs':'üíº –í–∞–∫–∞–Ω—Å–∏—è'};
    grid.innerHTML=items.map(p=>`
      <div class="my-post-card">
        <button class="my-post-del" onclick="delPost('${p.type}','${p.id}')" title="–£–¥–∞–ª–∏—Ç—å"><i class="fas fa-trash"></i></button>
        <div class="my-post-card-type">${tl[p.type]||''}</div>
        <div class="my-post-card-title">${_esc(p.title)}</div>
        <div style="font-size:.76rem;color:var(--text2)">${p.date?.toDate?_fmtD(p.date.toDate()):''}</div>
      </div>`).join('');
  } catch(e) { loader.style.display='none'; showToast('err','–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.'); }
}

function _showChat() {
  if(!_u){ document.getElementById('chatAuth').style.display='flex'; document.getElementById('chatSection').style.display='none'; return; }
  document.getElementById('chatAuth').style.display='none';
  document.getElementById('chatSection').style.display='block';
  _loadChatList();
}

function _loadChatList() {
  const q=query(collection(db,'chats'),where('participants','array-contains',_u.uid),orderBy('lastTime','desc'));
  onSnapshot(q, async snap => {
    const list=document.getElementById('chatListItems');
    if(!snap.docs.length){list.innerHTML='<div style="padding:14px;font-size:.83rem;color:var(--text2);text-align:center">–ß–∞—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';return;}
    let html='';
    for(const d of snap.docs){
      const data=d.data();
      const otherId=data.participants.find(id=>id!==_u.uid);
      try {
        const os=await getDoc(doc(db,'users',otherId));
        const o=os.data()||{};
        const av=o.photoURL||_ava(o.name);
        html+=`<div class="chat-item" onclick="openChat('${d.id}','${otherId}','${(o.name||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å').replace(/'/g,"\\'")}','${av}')">
          <img class="chat-item-ava" src="${av}" alt="">
          <div class="chat-item-info">
            <div class="chat-item-name">${_esc(o.name||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')}</div>
            <div class="chat-item-last">${_esc(data.lastMsg||'')}</div>
          </div>
          <div class="chat-item-time">${data.lastTime?.toDate?_fmtT(data.lastTime.toDate()):''}</div>
        </div>`;
      } catch(e){}
    }
    list.innerHTML=html;
  });
}

window.startChatFromPost = async () => {
  if(!_u){openModal('loginModal');return;}
  if(!_postData?.authorId) return;
  closeModal('postModal');
  goTab('chat');
  try {
    const os=await getDoc(doc(db,'users',_postData.authorId));
    const o=os.data()||{};
    openChat([_u.uid,_postData.authorId].sort().join('_'), _postData.authorId, o.name||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', o.photoURL||_ava(o.name));
  } catch(e){ showToast('err','–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç.'); }
};

window.openChat = async (chatId, otherId, otherName, otherAva) => {
  if(_chatUnsub){_chatUnsub();_chatUnsub=null;}
  _chatId=chatId;

  document.getElementById('chatEmpty').style.display='none';
  const ca=document.getElementById('chatActive');
  ca.style.display='flex';

  const av=document.getElementById('chatWinAva');
  av.style.backgroundImage=`url(${otherAva})`;
  av.style.backgroundSize='cover';
  av.style.backgroundPosition='center';
  document.getElementById('chatWinName').textContent=otherName;

  await setDoc(doc(db,'chats',chatId),{participants:[_u.uid,otherId],lastMsg:'',lastTime:serverTimestamp()},{merge:true});

  _chatUnsub=onSnapshot(query(collection(db,'chats',chatId,'messages'),orderBy('time','asc')), snap=>{
    const el=document.getElementById('chatMessages');
    el.innerHTML=snap.docs.map(d=>{
      const m=d.data(), mine=m.senderId===_u.uid;
      if(m.img) return `<div class="msg ${mine?'mine':'other'}"><img class="msg-img" src="${m.img}" onclick="window.open('${m.img}','_blank')" alt=""><div class="msg-time">${m.time?.toDate?_fmtT(m.time.toDate()):''}</div></div>`;
      return `<div class="msg ${mine?'mine':'other'}"><div class="msg-bubble">${_esc(m.text)}</div><div class="msg-time">${m.time?.toDate?_fmtT(m.time.toDate()):''}</div></div>`;
    }).join('');
    el.scrollTop=el.scrollHeight;
  });

  if(window.innerWidth<=768){
    document.getElementById('chatListPanel').classList.add('mob-hide');
    document.getElementById('chatWindowPanel').classList.remove('mob-hide');
    document.getElementById('chatBackBtn').style.display='flex';
  }
};

window.showChatList = () => {
  if(_chatUnsub){_chatUnsub();_chatUnsub=null;}
  document.getElementById('chatListPanel').classList.remove('mob-hide');
  document.getElementById('chatWindowPanel').classList.add('mob-hide');
  document.getElementById('chatBackBtn').style.display='none';
  document.getElementById('chatActive').style.display='none';
  document.getElementById('chatEmpty').style.display='flex';
};

window.sendMsg = async () => {
  if(!_u||!_chatId) return;
  const inp=document.getElementById('msgInput');
  const text=inp.value.trim();
  if(!text) return;
  inp.value='';
  await addDoc(collection(db,'chats',_chatId,'messages'),{text,senderId:_u.uid,time:serverTimestamp()});
  await updateDoc(doc(db,'chats',_chatId),{lastMsg:text,lastTime:serverTimestamp()});
};

window.sendImg = async (e) => {
  if(!_u||!_chatId) return;
  const file=e.target.files[0]; if(!file) return;
  showToast('warn','‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ...');
  try {
    const img=await uploadPhoto(file);
    await addDoc(collection(db,'chats',_chatId,'messages'),{img,senderId:_u.uid,time:serverTimestamp()});
    await updateDoc(doc(db,'chats',_chatId),{lastMsg:'üì∑ –§–æ—Ç–æ',lastTime:serverTimestamp()});
    showToast('ok','‚úÖ –§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
  } catch(er){ showToast('err','–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ.'); }
  e.target.value='';
};

window.switchProfileTab = (tab, btn) => {
  document.querySelectorAll('.profile-tab').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  document.getElementById('profileMyPosts').style.display  = tab==='myPosts'?'block':'none';
  document.getElementById('profileSettings').style.display = tab==='settings'?'block':'none';
  if(tab==='myPosts') loadMyPosts();
};

window.saveSettings = async () => {
  if(!_u) return;
  const name   = document.getElementById('settingsName').value.trim();
  const surname= document.getElementById('settingsSurname').value.trim();
  const pass   = document.getElementById('settingsPass').value;
  if(!name){ showToast('warn','‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∏–º—è'); return; }
  try {
    const full=name+(surname?' '+surname:'');
    await updateProfile(_u,{displayName:full});
    if(pass && pass.length>=6) await updatePassword(_u,pass);
    else if(pass && pass.length<6){ showToast('warn','‚ö†Ô∏è –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤'); return; }
    await updateDoc(doc(db,'users',_u.uid),{name,surname});
    _updateProfileUI();
    document.getElementById('userAvaBtn').src=_u.photoURL||_ava(full);
    showToast('ok','‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
  } catch(e){ showToast('err','–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.'); }
};

window.handleFab = () => {
  if(!_u){openModal('loginModal');return;}
  const tab=document.querySelector('.nav-tab.on')?.dataset.tab;
  if(tab==='market')                    openModal('addMarketModal');
  else if(tab==='jobs')                 openModal('addJobModal');
  else if(tab==='news'&&_u.uid===_A)    openModal('addNewsModal');
  else if(tab==='news')                 showToast('warn','‚ö†Ô∏è –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–æ–≤–æ—Å—Ç–∏');
  else showToast('warn','‚ö†Ô∏è –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –†—ã–Ω–æ–∫ –∏–ª–∏ –í–∞–∫–∞–Ω—Å–∏–∏');
};

window.toggleDD = (id,e) => {
  e.stopPropagation();
  document.querySelectorAll('.dropdown.show').forEach(d=>{ if(d.id!==id) d.classList.remove('show'); });
  document.getElementById(id)?.classList.toggle('show');
};
document.addEventListener('click',()=>document.querySelectorAll('.dropdown.show').forEach(d=>d.classList.remove('show')));

window.sharePost = (id) => {
  const url=`${location.origin}${location.pathname}?post=${id}`;
  navigator.share?navigator.share({title:'–ù–æ–æ–∫–∞—Ç –ù–æ–≤–æ—Å—Ç–∏',url}):navigator.clipboard.writeText(url).then(()=>showToast('ok','üîó –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!'));
};
window.reportPost = () => showToast('ok','‚ö†Ô∏è –ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –°–ø–∞—Å–∏–±–æ!');

window.previewFile = (e,pid) => {
  const file=e.target.files[0]; if(!file) return;
  const r=new FileReader();
  r.onload=ev=>{const img=document.getElementById(pid);img.src=ev.target.result;img.style.display='block';};
  r.readAsDataURL(file);
};
window.previewRegAva = (e) => {
  _avaFile=e.target.files[0]; if(!_avaFile) return;
  const r=new FileReader();
  r.onload=ev=>document.getElementById('regAvaPreview').src=ev.target.result;
  r.readAsDataURL(_avaFile);
};

window.checkStrength = (pass) => {
  const fill=document.getElementById('strengthFill'), text=document.getElementById('strengthText');
  let s=0;
  if(pass.length>=6)s++; if(pass.length>=10)s++; if(/[A-Z]/.test(pass))s++; if(/[0-9]/.test(pass))s++; if(/[^A-Za-z0-9]/.test(pass))s++;
  fill.style.width=(s*20)+'%';
  fill.style.background=['#ef4444','#f97316','#eab308','#22c55e','#10b981'][s-1]||'#ef4444';
  text.textContent=s>0?['–û—á–µ–Ω—å —Å–ª–∞–±—ã–π','–°–ª–∞–±—ã–π','–°—Ä–µ–¥–Ω–∏–π','–°–∏–ª—å–Ω—ã–π','–û—á–µ–Ω—å —Å–∏–ª—å–Ω—ã–π'][s-1]:'';
};

document.querySelectorAll('.lang-sw button').forEach(btn=>{
  btn.addEventListener('click',function(){
    document.querySelectorAll('.lang-sw button').forEach(b=>b.classList.remove('on'));
    this.classList.add('on');
    const lang=this.dataset.lang;
    document.querySelectorAll('[data-ru]').forEach(el=>el.textContent=el.getAttribute('data-'+lang)||el.textContent);
    localStorage.setItem('lang',lang);
  });
});
if(localStorage.getItem('lang')==='kg'){
  document.querySelectorAll('.lang-sw button').forEach(b=>b.classList.toggle('on',b.dataset.lang==='kg'));
  document.querySelectorAll('[data-ru]').forEach(el=>el.textContent=el.getAttribute('data-kg')||el.textContent);
}

window.toggleTheme = () => {
  document.body.classList.toggle('dark');
  const dark=document.body.classList.contains('dark');
  document.getElementById('themeBtn').textContent=dark?'‚òÄÔ∏è':'üåô';
  localStorage.setItem('theme',dark?'dark':'light');
};
if(localStorage.getItem('theme')==='dark'){document.body.classList.add('dark');document.getElementById('themeBtn').textContent='‚òÄÔ∏è';}

window.goTab = (name) => {
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('on'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('on'));
  document.getElementById('sec-'+name)?.classList.add('on');
  document.querySelector(`.nav-tab[data-tab="${name}"]`)?.classList.add('on');
  if(name==='chat')    _showChat();
  if(name==='profile') loadMyPosts();
  if(name==='news')    document.getElementById('newsSearch').value='';
  if(name==='market')  document.getElementById('marketSearch').value='';
  if(name==='jobs')    document.getElementById('jobsSearch').value='';
};

window.openModal  = id => document.getElementById(id)?.classList.add('show');
window.closeModal = id => document.getElementById(id)?.classList.remove('show');
document.querySelectorAll('.overlay').forEach(o=>{
  o.addEventListener('click',e=>{ if(e.target===o) o.classList.remove('show'); });
});

document.querySelectorAll('.cat-btn').forEach(btn=>{
  btn.addEventListener('click',function(){
    document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('on'));
    this.classList.add('on');
    _cat=this.dataset.cat;
    filterMarket();
  });
});

window.addEventListener('scroll',()=>document.getElementById('scrollUp').classList.toggle('show',window.pageYOffset>300));

window.showToast = (type,text) => {
  const t=document.getElementById('toast');
  t.className='toast '+type+' show';
  t.innerHTML=`<span>${type==='ok'?'‚úÖ':type==='err'?'‚ùå':'‚ö†Ô∏è'}</span> <span>${text}</span>`;
  clearTimeout(window._tt);
  window._tt=setTimeout(()=>t.classList.remove('show'),3500);
};
</script>
</body>
</html>
